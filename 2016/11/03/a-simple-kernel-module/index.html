<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        编写一个简单的Linux内核模块 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/spring.png">
        </div>
        <div class="name">
            <i>rason</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
<!--            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
    -->        <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#可加载的内核模块"><span class="toc-text">可加载的内核模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#超级用户权限"><span class="toc-text">超级用户权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#‘insmod’-and-‘rmmod’"><span class="toc-text">‘insmod’ and ‘rmmod’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个新的内核模块"><span class="toc-text">创建一个新的内核模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跟C程序的另外一下不同点"><span class="toc-text">跟C程序的另外一下不同点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用C语言编写一个内核模块"><span class="toc-text">用C语言编写一个内核模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Makefile文件"><span class="toc-text">Makefile文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译、安装、移除"><span class="toc-text">编译、安装、移除</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        编写一个简单的Linux内核模块
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2016-11-03 15:51:49</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#Linux" title="Linux">Linux</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Linux的可扩展性体现在两个方面：</p>
<ul>
<li>开源</li>
<li>可加载的内核模块（LKMs, Loadable kernel module）</li>
</ul>
<p>今天我们来认识一下LKM并编写一个简单的内核模块。</p>
<h2 id="可加载的内核模块"><a href="#可加载的内核模块" class="headerlink" title="可加载的内核模块"></a>可加载的内核模块</h2><ul>
<li>是一项方便扩展操作系统的技术</li>
<li>同时让我们了解到内核是如何工作的</li>
<li>内核运行时也可以进行修改</li>
<li>不需要重新编译和重启</li>
<li>因而它也是不安全的，有bug的话容易造成系统崩溃</li>
</ul>
<h2 id="超级用户权限"><a href="#超级用户权限" class="headerlink" title="超级用户权限"></a>超级用户权限</h2><ul>
<li>修改运行中的内核是很危险的</li>
<li>只有授权的系统管理员才可以安装内核模块</li>
</ul>
<h2 id="‘insmod’-and-‘rmmod’"><a href="#‘insmod’-and-‘rmmod’" class="headerlink" title="‘insmod’ and ‘rmmod’"></a>‘insmod’ and ‘rmmod’</h2><p>安装内核模块：<code>$  /sbin/insmod  myLKM.ko</code></p>
<p>移除内核模块：<code>$  /sbin/rmmod  myLKM</code></p>
<p>列出已安装的内核模块：<code>$  /sbin/lsmod</code></p>
<h2 id="创建一个新的内核模块"><a href="#创建一个新的内核模块" class="headerlink" title="创建一个新的内核模块"></a>创建一个新的内核模块</h2><ul>
<li>可以用任何文本编辑器编写Linux内核源码</li>
<li>内核模块和普通的C程序有点不一样，比如没有main()方法</li>
<li>内核模块不能调用标准C运行库的方法</li>
<li>对于任何的LKM，必须要有两个切入点，一个用于initialization，一个用于cleanup</li>
</ul>
<a id="more"></a>
<h2 id="跟C程序的另外一下不同点"><a href="#跟C程序的另外一下不同点" class="headerlink" title="跟C程序的另外一下不同点"></a>跟C程序的另外一下不同点</h2><ul>
<li>内核模块用printk()代替printf()</li>
<li>包含&lt;linux/module.h&gt;头文件</li>
<li>指定一个合法的软件License（GPL）</li>
<li>编译需要一个专用的Makefile</li>
<li>没有权限控制</li>
</ul>
<h2 id="用C语言编写一个内核模块"><a href="#用C语言编写一个内核模块" class="headerlink" title="用C语言编写一个内核模块"></a>用C语言编写一个内核模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;		// for printk()</span><br><span class="line"></span><br><span class="line">int init( void )</span><br><span class="line">&#123;</span><br><span class="line">	printk( &quot;\n Hello, everybody! \n&quot; );</span><br><span class="line"></span><br><span class="line">	return	0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void exit( void )</span><br><span class="line">&#123;</span><br><span class="line">	printk( &quot;\n   Goodbye now... \n\n&quot; );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line">module_init(init);</span><br><span class="line">module_exit(exit);</span><br></pre></td></tr></table></figure>
<h2 id="Makefile文件"><a href="#Makefile文件" class="headerlink" title="Makefile文件"></a>Makefile文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ifneq	($(KERNELRELEASE),)</span><br><span class="line">obj-m	:= kello.o </span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">KDIR	:= /lib/modules/$(shell uname -r)/build</span><br><span class="line">PWD	:= $(shell pwd)</span><br><span class="line">default:	</span><br><span class="line">	$(MAKE) -C $(KDIR) SUBDIRS=$(PWD) modules </span><br><span class="line">	rm -r -f .tmp_versions *.mod.c .*.cmd *.o *.symvers </span><br><span class="line"></span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<h2 id="编译、安装、移除"><a href="#编译、安装、移除" class="headerlink" title="编译、安装、移除"></a>编译、安装、移除</h2><p>编译：</p>
<ul>
<li><code>$ make -f Makefile</code></li>
<li><code>$ make</code>,前提是kello.c和Makefile在同一目录下。</li>
</ul>
<p>安装：</p>
<ul>
<li><code>$ sudo /sbin/insmod kello.ko</code></li>
<li><code>$ /sbin/insmod</code> 查看是否安装成功</li>
<li><code>$ dmesg</code> 查看内核日志</li>
</ul>
<p>删除：</p>
<ul>
<li><code>$ sudo /sbin/rmmod kello</code></li>
</ul>
<p>完。</p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
<!--        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p> -->
</p></footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
