<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        访问高区内存
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/spring.png">
        </div>
        <div class="name">
            <i>rason</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
<!--            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
    -->        <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux内核的解决方案"><span class="toc-text">Linux内核的解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存映射函数"><span class="toc-text">内存映射函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内核空间可视化"><span class="toc-text">内核空间可视化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kmap-如何工作"><span class="toc-text">kmap()如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kmap-high-如何工作"><span class="toc-text">kmap_high()如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kunmap-的目的"><span class="toc-text">kunmap()的目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引用计数器"><span class="toc-text">引用计数器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#刷新TLB"><span class="toc-text">刷新TLB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中断程序如何处理"><span class="toc-text">中断程序如何处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#临时映射kmap-atomic"><span class="toc-text">临时映射kmap_atomic()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-text">扩展阅读</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        访问高区内存
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2016-12-05 13:55:57</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#HighMemery" title="HighMemery">HighMemery</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>32位系统最大的寻址范围是4GB，通常会将这4GB虚拟内存地址空间分成3GB的用户空间和1GB的内核空间。也就是说内核能直接映射到物理地址的最大范围是1GB的地址（实际上只有896MB直接映射），那么内核怎么访问超过1GB的物理地址？今天我们来学习Linux内核的解决方案。</p>
<h2 id="Linux内核的解决方案"><a href="#Linux内核的解决方案" class="headerlink" title="Linux内核的解决方案"></a>Linux内核的解决方案</h2><ul>
<li>高区内存页框只有在真正需要的时候才会被映射</li>
<li>这些页框用完之后会被释放以便其它页框可以重用相同的虚拟地址</li>
<li>当然这些共享只适用于高区内存</li>
</ul>
<h2 id="内存映射函数"><a href="#内存映射函数" class="headerlink" title="内存映射函数"></a>内存映射函数</h2><ul>
<li><code>kmap()</code>函数可以创建一个新的页映射</li>
<li><code>kunmap()</code>函数可以释放映射</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/highmem.h&gt;</span><br><span class="line">void * kmap( struct page * page );</span><br><span class="line">void kunmap( struct page * page );</span><br></pre></td></tr></table></figure>
<h2 id="内核空间可视化"><a href="#内核空间可视化" class="headerlink" title="内核空间可视化"></a>内核空间可视化</h2><ul>
<li>896MB以下的内存直接映射</li>
<li><code>phys_to_virt()</code>物理地址转虚拟地址直接加上0xC0000000</li>
<li><code>virt_to_phys()</code>虚拟地址转物理地址直接减去0xC0000000</li>
</ul>
<h2 id="kmap-如何工作"><a href="#kmap-如何工作" class="headerlink" title="kmap()如何工作"></a>kmap()如何工作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void * kmap( struct page * page )</span><br><span class="line">&#123;</span><br><span class="line">	if ( page &lt; highmem_start_page )</span><br><span class="line">		return  page-&gt;virtual;</span><br><span class="line">	return  kmap_high( page );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="kmap-high-如何工作"><a href="#kmap-high-如何工作" class="headerlink" title="kmap_high()如何工作"></a>kmap_high()如何工作</h2><ul>
<li>内核首先执行一个快速的检查</li>
<li>判断高区页是否已经映射</li>
<li>如果是则直接返回存在的虚拟地址</li>
<li>如果没有则找到一个没有使用的虚拟地址</li>
<li>设置映射该页的页表项</li>
<li>但是，也有可能找不到未被使用的项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void kmap_high( struct page * page )</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long	vaddr;</span><br><span class="line">	spin_lock( &amp;kmap_lock );</span><br><span class="line">	vaddr = (unsigned long)page-&gt;virtual;</span><br><span class="line">	if ( !vaddr ) vaddr = map_new_virtual( page );</span><br><span class="line">	++pkmap_count[ (vaddr - PKMAP_BASE)&gt;&gt;12 ];</span><br><span class="line">	spin_unlock( &amp;kmap_lock );</span><br><span class="line">	return	(void *)vaddr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果新的内核映射没成功（因为所有的地址已经被使用），那么<code>map_new_virtual()</code>函数会阻塞这个任务（进入睡眠）</li>
</ul>
<h2 id="kunmap-的目的"><a href="#kunmap-的目的" class="headerlink" title="kunmap()的目的"></a>kunmap()的目的</h2><ul>
<li>程序流程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void  * vaddr = kmap( page );	  // get address</span><br><span class="line">	… </span><br><span class="line">/* use this virtual address to access the page */ </span><br><span class="line">	…</span><br><span class="line">kunmap( page );	       // release the address</span><br></pre></td></tr></table></figure>
<ul>
<li>然后内核就可以唤醒被阻塞的任务了</li>
</ul>
<h2 id="引用计数器"><a href="#引用计数器" class="headerlink" title="引用计数器"></a>引用计数器</h2><ul>
<li>内核维护着一个计数器数组<code>static int pkmap_count[ LAST_PKMAP ]</code></li>
<li>高区内存每一页都有一个计数器</li>
<li>计数器的值可以为0,1或者比1大</li>
<li>等于0代表页没有被映射</li>
<li>等于1表示现在没有被映射，但是曾经被映射</li>
<li>大于1表示被映射n-1次</li>
</ul>
<h2 id="刷新TLB"><a href="#刷新TLB" class="headerlink" title="刷新TLB"></a>刷新TLB</h2><ul>
<li><code>kunmap( page )</code>会减少引用计数</li>
<li>当<code>refcount == 1</code>，映射就不需要了</li>
<li>但是CPU还缓存着映射</li>
<li>所以要刷新缓存使其失效</li>
<li>但是在多CPU系统中，每个CPU都需要刷新</li>
</ul>
<h2 id="中断程序如何处理"><a href="#中断程序如何处理" class="headerlink" title="中断程序如何处理"></a>中断程序如何处理</h2><ul>
<li>中断处理器不能冒险使用<code>kmap()</code>，因为其性能低，使用锁会阻塞</li>
<li>但是还是需要访问高区内存的数据</li>
<li>所以需要一个备用方案在需要时映射数据</li>
</ul>
<h2 id="临时映射kmap-atomic"><a href="#临时映射kmap-atomic" class="headerlink" title="临时映射kmap_atomic()"></a>临时映射kmap_atomic()</h2><ul>
<li>保留了少数备用的页表项</li>
<li>每个CPU只有五六个页表项</li>
<li>中断处理器可以安全地使用</li>
<li>临时的页映射速度很快，因为它没有锁</li>
<li>不保证映射会持久</li>
<li>不需要unmapping</li>
<li>也不会和其他CPU产生TLB冲突</li>
</ul>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><ol>
<li><a href="https://en.wikipedia.org/wiki/High_memory" target="_blank" rel="noopener">Wikipedia Highmemery</a></li>
<li><a href="https://linux-mm.org/HighMemory" target="_blank" rel="noopener">HighMemery</a></li>
</ol>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
<!--        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a>-->
 <a href="http://www.beian.miit.gov.cn">粤ICP备17046371号-1</a>  
</p> 
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
