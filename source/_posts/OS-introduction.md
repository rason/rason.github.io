title: 操作系统介绍
categories: OS
date: 2016-09-02 13:32:26
tags: 操作系统
description: 操作系统介绍
---

## 前言

接下来的一段时间打算学习一下操作系统方面的知识，正好看到一技术公众账号有推荐《现代操作系统》一书，便决定下载看看。阅读了一章书之后感觉还可以，就选定此书作为接下来的学习资料了。

## 什么是操作系统

我们都知道计算机系统由CPU、主存、磁盘、打印机、键盘、鼠标、显示器以及其他的输入/输出设备组成。我们程序员跟不可能直接跟这些底层硬件打交道吧？那不是累死累活。我们都知道解耦，面向接口编程思想，操作系统的作用正是如此。如下图所示：

![操作系统所处的位置](/image/os-position)

从上图可以看出，操作系统就是架设在用户和硬件之间的一层软件，其作用大致有一下两点：

- 隐藏硬件，呈现给程序（以及程序员）良好、清晰、优雅、一致的抽象。
- 在互相竞争的程序之间有序地控制对处理器、存储器以及其他I/O接口设备的分配。

对于第二点，资源管理用两种不同的方式实现多路复用（共享）资源：时间上复用和空间上复用。

 - 时间上复用：CPU轮换、打印机排队
 - 空间上复用：每个客户都得到资源的一部分，从而取代客户排队。比如若干运行程序之间分配内存和分配磁盘空间并记录谁正在使用哪个磁盘块。

另外，上图中还标识了**内核态和用户态**,这正是大多数计算机的两种运行模式。操作系统运行在内核态，对所有硬件有完全访问权，可以执行机器能够运行的任何指令；而用户态下，只能使用机器指令中的一个子集。这种思想跟Java类加载器其实是差不多的，都是为了安全起见，要是我们编写的程序能随意执行机器的任何指令，估计没一会就报废了。

此外，图中还有一项用户接口程序是什么鬼？比如shell和GUI，它们处于用户态程序中的最低层次，允许用户运行其他程序，比如浏览器等。

<!-- more -->

## 计算机硬件介绍

一台简单的个人计算机可以抽象为类似下图中的模型。CPU、内存以及I/O设备都由一条系统总线连接起来并通过总线与其他设备通信。

![简单的个人计算机的一些部件](/image/pc-component)

### 处理器

CPU就是计算机的大脑，它从内存中取出指令并执行之。在每个CPU基本周期中，首先从内存中取出指令，解码以确定其类型和操作数，接着执行之，然后取指、解码并执行下一条指令。

由于访问内存得到指令或数据的时间比执行指令的时间长得多，所以CPU内部有一些用来保存关键变量和临时数据的寄存器。除此之外，还有一些程序员可见的寄存器：

- **程序计算器**：保存将要取出的下一条指令的内存地址。指令取出之后，程序计数器就被更新指向后继的指令。

- **堆栈寄存器**：堆栈指针指向内存中当前栈的顶端。

- **状态寄存器**：也称程序状态字（PSW）寄存器。这个寄存器包含了条件码位、CPU优先级、模式（用户态或内核态），以及各种其他控制位。

操作系统必须知晓所有的寄存器，在时间多路复用CPU中，操作系统经常会终止正在运行的某个程序并启动另一个程序。这时就需要保存所有的寄存器，当程序再次运行时，可以把这些寄存器重新装入。

### 存储器

上面说到的寄存器和内存都是存储器的一种，那么计算机究竟有多少存储器，它们之间的区别是什么？请看下图：

![典型的存储层次结构，数据是粗略估计](/image/memory-structure)

从上图可以看出，没有两全其美的方案，速度快的容量小（材料、制作成本高），速度慢的容量大（材料、制作成本低）。需要提到的是高速缓存，当某个程序需要读取一个存储字时，高速缓存硬件检查所需要的高速缓存行是否在高速缓存中，如果缓存命中则不需要访问内存了。缓存在计算机科学的许多领域中都起着重要的作用。

### I/O设备

I/O设备一般包括两个部分：设备控制器和设备本身。控制器是插在电路板上的一块芯片或一组芯片，它从操作系统接收命令。例如，从设备读取数据，并且完成数据的处理。

在许多情况下，对这些设备的控制是非常复杂和具体的，所以，控制器的任务是为操作系统提供一个简单的接口（不过还是很复杂的）。这其实就是面向接口编程的思想。操作系统看到的是对控制器的接口，这个接口可能和设备接口有很多大区别。

然而每类设备控制器都是不同的，所以需要不同的软件进行控制。专门与控制器对话，发出命令并接收响应的软件，就是我们日常中安装的**设备驱动程序**。为了能够使用设备驱动程序，必须把设备驱动程序装入到操作系统中，这样它可在核心态中运行。

每个设备控制器都有少量的用于通信的寄存器。实现输入和输出的方式有三种：

- **忙等待**：程序发出系统调用，CPU一致轮询设备知道对应的I/O操作完成。
- **中断**：设备驱动程序启动设备并且让该设备在操作完成时发出一个中断。
- **直接存储器访问**：为I/O使用一种特殊的直接存储器（DMA）访问芯片，它可以控制在内存和某些控制器之间的位流，而无须持续的CPU干预。

### 总线

随着处理器和存储器速度越来越快，单总线很难处理总线的交通流量，因此就出现了其它总线，它们处理I/O设备以及CPU到存储器的速度都更快。目前一个较大的Pentium系统的结构如下图所示：

![大型Pentium系统的结构](/image/bus-structure)

- ISA（Industry Standard Architecture）总线：即原先的IBM PC/AT总线，可并行传送2字节，速度较慢。
- PCI（Peripheral Component Interconnect）总线：ISA总线的后继者，可并行传送8字节，速度较快。目前多数高速I/O设备采用PCI总线。
- IDE总线：将诸如磁盘和CD-ROM一类的外部设备与系统相连接。
- USB总线：用来将所有慢速I/O设备，如鼠标和键盘，与计算机连接。
- SCSI总线：一种高速总线，用在高速硬盘、扫描仪和其他需要较大带宽的设备上。

## 操作系统概念

多数操作系统都使用某些基本概念和抽象，诸如进程、地址空间以及文件等，它们是需要理解的中心。

### 进程

进程本质上是正在执行的一个程序。与每个进程相关的是进程的**地址空间**，这是从某个最小值的存储位置（通常是零）到某个最大值存储位置的列表。在这个地址空间中，进程可以进行读写。该地址空间存放有可执行程序、程序的数据以及程序的堆栈。

与每个进程相关的还有资源集，通常包括寄存器（含有程序计数器和堆栈指针）、打开文件的清单、突出的报警、有关进程清单，以及运行该程序所需要的所有其他信息。这些信息均存放在操作系统的一张表中，称为**进程表**。

所以，一个（挂起的）进程包括：进程的地址空间以及对应的进程表项。

与进程管理有关的最关键的系统调用是那些进行进程创建和进程终止的系统调用。其他可用的进程系统调用包括：申请更多的内存、等待一个子进程结束、用另一个程序覆盖该程序等。

一个进程可以创建一个或多个子进程，子进程也可以创建子进程，这样很容易得到进程树。合作完成某些作业的相关进程经常需要彼此通信以便同步它们的行为，这种通信称为**进程间通信**。

### 地址空间

通常，每个进程有一些可以使用的地址集合，典型值是从0开始到某个最大值。在最简单的情况下，一个进程可拥有的最大地址空间小于主存。在这种方式下，进程可以用满其地址空间，而且内存中也有足够的空间容纳该进程。

但是，如果一个进程有比主存更大的地址空间，而且该进程希望使用全部的内存，这就需要用到**虚拟内存技术**。

### 文件

操作系统的一项主要功能是隐藏磁盘和其他I/O设备的细节特性，并提供给程序员一个良好、清晰的独立于设备的抽象文件模型。显然，创建文件、删除文件、读文件和写文件等都需要系统调用。

进程和文件层次都可以组织成树状结构，但一般进程的树状结构层次不深（很少超过三层），而文件树状层次常常多达四五层或更多。进程树层次结构是暂时的，通常最多存在几分钟，而目录层次则可能存在数年之久。进程和文件在所有权以及保护方面也是有区别的。典型地，只有父进程能控制和访问子进程，而在文件和目录中通常存在一种机制，使文件所有者之外的其他用户也可以访问该文件。

### 输入/输出

所有的计算机都有用来获取输入和产生输出的物理设备。每个操作系统都有管理其I/O设备的I/O子系统。

## 系统调用

任何单CPU计算机一次只能执行一条指令。如果一个进程正在用户态中运行一个用户程序，并且需要一个系统服务，比如从一个文件读数据，那么它就必须执行一个陷阱或系统调用指令，将控制转移到操作系统。操作系统接着通过参数检查，找出所需要的调用进程。然后，它执行系统调用，并把控制返回给在系统调用后面跟随着的指令。在某种意义上，进行系统调用就像进行一个特殊的过程调用，但是只有系统调用可以进入内核，而过程调用则不能。

## 总结

本文简述了操作系统的作用和一些基本概念，还有计算机硬件的基本介绍。内容比较简单，作为后面学习的基础。
