title: IP协议相关技术
categories: Network
date: 2016-04-21 10:59:36
tags: Network
description: IP协议相关技术
---

## 前言

仅仅利用IP协议是无法进行网络通信的，还需要一些IP的辅助技术。这一篇文章文章盘点一下IP的一些辅助技术。

## DNS

我们不会直接在浏览器中输入IP地址访问某个网站，因为是在太难记忆了。所以就出现了用域名代替IP地址，但是网络通信是利用IP地址进行通信的。所以就出现了DNS（Domain Name System），即域名系统，通过域名系统可以查询到域名对应的IP地址。

域名系统（DNS）是因特网的一项服务，它作为将**域名**和**IP地址**互相映射的一个分布式数据库，能够使人更方便地访问互联网。

### 域名解析

DNS查询有两种方式：**递归和迭代**。DNS客户端设置使用的DNS服务器一般都是递归服务器，它负责全权处理客户端的DNS查询请求，直到返回最终结果。而DNS服务器之间一般采用迭代查询。

以查询zh.wikipedia.org为例：

- 客户端发送查询报文“query zh.wikipedia.org”至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。

- 不存在。DNS服务器向**根域名服务器**发送查询报文“query zh.wikipedia.org”,根域名服务器返回.org域的权威域名服务器地址，这一级首先会返回的是**顶级域名**的权威域名服务器。

- DNS服务器向.org域的权威域名服务器发送查询报文“query zh.wikipedia.org”，得到“.wikipedia.org”域的权威域名服务器地址。

- DNS服务器向.wikipedia.org域的权威域名服务器发送查询报文“query zh.wikipedia.org”，得到主机zh的A记录，存入自身缓存并返回给客户端。

<!-- more -->

## ARP

只要确定了IP地址，就可以向这个目标地址发送IP数据包。然而，在底层数据链路层，进行实际通信时却有必要了解到每个IP地址对应的MAC地址。

ARP是一种解决地址问题的协议。以目标IP地址为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。如果目标主机不再同一个链路上时，可以通过ARP查找下一跳路由器对应的MAC地址。不过ARP只适用于IPv4，在IPv6中用ICMPv6代替ARP发送邻居探索消息。

ARP借助**ARP请求**与**ARP响应**两种类型的包确定MAC地址的。比如主机A为了获取主机B的MAC地址：

- A广播一个ARP请求包，该包包含B的IP地址
- 同一链路中的主机或路由器收到请求包，判断目标IP地址是否与自己的IP地址一致
- 如果一致，则将自己的MAC地址塞入ARP响应包返回给主机A

### RARP

RARP就是将ARP反过来，从MAC地址定位IP地址的一种协议。例如将打印机等小型嵌入式设备接入到网络时就经常会用到。

个人电脑可以设置IP地址，也可以通过**DHCP**自动分配获取IP地址。然而，对于嵌入式设备时，会遇到没有任何输入接口或无法通过DHCP动态获取IP地址的情况。在这类情况下，就可以使用RARP。

为此，需要架设一台**RARP服务器**，从而在这个服务器上注册设备的MAC地址及其IP地址。然后再将设个设备接入到网络，启动设备时会发送一条“我的MAC地址是xxx，请告诉我我的IP地址”。设备就可以从RARP服务器获取到自己的IP。

## ICMP

架构IP网络时需要特别注意两点：确认网络是否正常工作，以及遇到异常时进行问题诊断。ICMP正是提供这类功能的一种协议。

ICMP的主要功能包括，确认IP包是否成功送达目标地址，通知在发送过程中IP包被废弃的具体原因，改善网络设置等。比如，上一篇文章谈到的路径MTU，就是利用ICMP通知数据链路层的MTU大小，进而进行分片处理。

ICMP的消息大致可以分为两类：

- **通知出错原因的错误消息**
- **用于诊断的查询消息**

具体包含：回送应答、目标不可达、原点抑制、重定向或改变路由、回送请求、路由器公告、路由器请求、超时、地址子网请求、地址子网应答等。详细可见[维基百科](https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%94%E7%BD%91%E6%8E%A7%E5%88%B6%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE)。

## DHCP

如果逐一为每一台主机设置IP地址会非常繁琐，为了实现自动设置IP地址、统一管理IP地址分配，就产生了DHCP（Dynamic Host Configuration Protocol）协议。

使用DHCP之前，需要架设一台DHCP服务器，然后将DHCP索要分配的IP地址设置到服务器上。此外，还需要将相应的子网掩码、路由控制信息以及DNS服务器的地址等设置到服务器上。通过DHCP获取IP地址的流程：先发送请求设置IP地址和子网掩码，通知可以设置后；再发送DHCP请求包，DHCP服务器返回提供包进行设置。

为了检查所要分配的IP地址是否可用，DHCP服务器或DHCP客户端必须具有一下功能：

- **DHCP服务器**：在分配IP地址前发送ICMP回送请求包，确认没有返回应答。

- **DHCP客户端**：针对从DHCP那里获得的IP地址发送ARP请求包，确认没有返回应答。

### DHCP中继代理

对于一个企业或者学校等大规模的组织机构网络环境中，一般会有多个以太网（无线LAN）网段。若要针对每个网段都设置DHCP服务器将会时一个庞大的工程。而且各自管理也不利于维护，所以就出现了中继代理。每个网段设置一个DHCP中继代理，代理将请求发送到统一的一台DHCP服务器进行处理。

## NAT

NAT（Network Address Translator）是用于本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。除了转换IP地址外，还出现了可以转换TCP、UDP端口号的NAPT技术，由此可以实现用一个全局IP地址与多个主机的通信。

### 基本网络地址转换（Basic NAT）

这一种也称作NAT或“静态NAT”。仅支持地址转换，不支持端口映射，这就需要对每一个当前连接都要对应一个IP地址，因此要维护一个公网的地址池。

基本NAT要维护一个NAT表，结构如下：

| 内网IP | 外网IP |
| :-----------: | :-------: |
| 192.168.1.55 | 219.152.168.222 |
| 192.168.1.59 | 219.152.168.223 |
| 192.168.1.155 | 219.152.168.224 |  

### 网络地址端口转换（NAPT）

这种方式支持端口的映射并允许多台主机共享一个公用IP地址。

NAPT也要维护一个NAT表，结构如下：

| 内网IP | 外网IP |
| :-----------: | :-------: |
| 192.168.1.55：5566 | 219.152.168.222:9200 |
| 192.168.1.55：80 | 219.152.168.222:9201 |
| 192.168.1.55：4466 | 219.152.168.222:9202 |

## 总结

另外还有一些其它的辅助技术就不介绍了，比如IP隧道、IP多播、任播相关技术、通信质量控制等。本文主要是大概介绍了一下**DNS、ARP、ICMP、DHCP、NAT**这几项辅助技术，详细的介绍可以自己上维基百科搜索查看。
