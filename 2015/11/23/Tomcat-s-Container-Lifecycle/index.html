<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Tomcat的Container和Lifecycle
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/spring.png">
        </div>
        <div class="name">
            <i>rason</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
<!--            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
    -->        <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Container（容器）"><span class="toc-text">Container（容器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lifecycle（生命周期）"><span class="toc-text">Lifecycle（生命周期）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat的启动流程"><span class="toc-text">Tomcat的启动流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Tomcat的Container和Lifecycle
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2015-11-23 15:49:27</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#Container Lifecycle" title="Container Lifecycle">Container Lifecycle</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <p>上篇文章<a href="http://rason.me/2015/11/19/Tomcat-Architecture/" target="_blank" rel="noopener">Tomcat架构</a>中梳理了一下Tomcat的基本架构，现在来介绍一下Tomcat里面的两个接口<code>Container</code>和<code>Lifecycle</code>，为深入了解Tomcat的工作原理打下基础。</p>
<h2 id="Container（容器）"><a href="#Container（容器）" class="headerlink" title="Container（容器）"></a>Container（容器）</h2><p><strong>一个Container对象可以接收来自客户端的请求，并基于这些请求返回响应信息。Container可以通过实现Pipeline接口支持管道阀门，按运行时配置的顺序处理请求。</strong></p>
<p>在Tomcat中，Container（容器）会以以下的概念存在：</p>
<ul>
<li><p><strong>Engine</strong><br>代表一个完整的servlet引擎，可以包含一个或者多个子容器（Host,Context或者自定义的组）</p>
</li>
<li><p><strong>Host</strong><br>代表一个包含一系列Context的虚拟主机</p>
</li>
<li><p><strong>Context</strong><br>代表一个单一的ServletContext，可以包含一个或者多个Wrapper</p>
</li>
<li><p><strong>Wrapper</strong><br>代表一个servlet定义，servlet在tomcat中是以Wrapper形式出现</p>
</li>
</ul>
<a id="more"></a>
<p>以上的内容一定很熟悉，因为<a href="http://rason.me/2015/11/19/Tomcat-Architecture/" target="_blank" rel="noopener">Tomcat架构</a>文章就介绍过，原来他们都实现了同一个接口，我们来看看Container接口里面都有些什么方法：</p>
<p><img src="https://raw.githubusercontent.com/rason/rason.github.io/master/image/container.png" alt="Container接口方法"></p>
<p>方法比较多，但从名字上我们大概就知道用途，不多做解析。我们可以看到有一个<code>addChild(Container child)</code>添加子容器的方法，从<a href="http://rason.me/2015/11/19/Tomcat-Architecture/" target="_blank" rel="noopener">Tomcat架构</a>文章中的构架图可以看出，Tomcat中的Container是一层接一层的。那么，Tomcat是怎么将这些容器组件有效地管理起来呢？</p>
<h2 id="Lifecycle（生命周期）"><a href="#Lifecycle（生命周期）" class="headerlink" title="Lifecycle（生命周期）"></a>Lifecycle（生命周期）</h2><p>Container接口扩展于Lifecycle接口，因此可以知道Tomcat正是通过Lifecycle来管理上面那些容器组件的。我们知道Servlet是有init，service，destroy这些生命周期的，Tomcat中的容器（Container）生命周期和Servlet的生命周期类似。</p>
<p>先看一下Lifecycle的结构和方法：</p>
<p><img src="https://raw.githubusercontent.com/rason/rason.github.io/master/image/lifecycle.png" alt="Lifecycle数据结构和方法"></p>
<p>可以看出Lifecycle主要有<strong>init，start，stop，destroy</strong>四个过程。而对应的生命周期状态却有以下几种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public enum LifecycleState &#123;</span><br><span class="line">    NEW(false, null),</span><br><span class="line">    INITIALIZING(false, Lifecycle.BEFORE_INIT_EVENT),</span><br><span class="line">    INITIALIZED(false, Lifecycle.AFTER_INIT_EVENT),</span><br><span class="line">    STARTING_PREP(false, Lifecycle.BEFORE_START_EVENT),</span><br><span class="line">    STARTING(true, Lifecycle.START_EVENT),</span><br><span class="line">    STARTED(true, Lifecycle.AFTER_START_EVENT),</span><br><span class="line">    STOPPING_PREP(true, Lifecycle.BEFORE_STOP_EVENT),</span><br><span class="line">    STOPPING(false, Lifecycle.STOP_EVENT),</span><br><span class="line">    STOPPED(false, Lifecycle.AFTER_STOP_EVENT),</span><br><span class="line">    DESTROYING(false, Lifecycle.BEFORE_DESTROY_EVENT),</span><br><span class="line">    DESTROYED(false, Lifecycle.AFTER_DESTROY_EVENT),</span><br><span class="line">    FAILED(false, null),</span><br><span class="line">    MUST_STOP(true, null),</span><br><span class="line">    MUST_DESTROY(false, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>当容器（Container）组件的状态为STARTING_PREP, STARTING 或者STARTED时，调用生命周期的start()方法是没有作用的。</strong></li>
<li><strong>当容器（Container）组件的状态为NEW时，调用生命周期的start()方法时会首先调用init()方法。</strong></li>
</ul>
<p>另外我们还注意到Lifecycle接口中还有<code>addLifecycleListener(LifecycleListener listener)</code>方法。很显然这是一个<strong>监听器</strong>模式，监听事件的常量也可以在接口中看到，当生命周期变化时可以调用<code>fireLifecycleEvent</code>方法通知相应的监听器。</p>
<h2 id="Tomcat的启动流程"><a href="#Tomcat的启动流程" class="headerlink" title="Tomcat的启动流程"></a>Tomcat的启动流程</h2><p><strong>Tomcat的启动是基于观察者模式设计的，所有的容器会继承Lifecycle接口，它管理着容器的整个生命周期，所有容器的修改和状态改变都会由它去通知已注册的观察者。</strong>Tomcat的启动时序图如图：</p>
<p><img src="https://raw.githubusercontent.com/rason/rason.github.io/master/image/tomcat_start.png" alt="Tomcat启动时序图"></p>
<p>有了Container和Lifecycle的基础之后，理解上图应该不是很困难，容器之间是层层关联起来的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><strong>1.我们需要知道Engine，Host，Context，Wrapper都实现了Container接口。</strong></li>
<li><strong>2.Container接口扩展了Lifecycle接口，用于管理容器的生命周期。</strong></li>
<li><strong>3.Tomcat的启动流程就是一系列容器初始化和调用的过程。</strong></li>
</ul>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
<!--        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a>-->
 <a href="http://www.beian.miit.gov.cn">粤ICP备17046371号-1</a>  
</p> 
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
